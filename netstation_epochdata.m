%% Netstation Epoch Data
% Converts Epoched data from Netstation into a fieldtrip format to be run
% through Surface Laplacian conversion and Time Frequency decomposition.
% 
% 

%Setup refdat struct and working parameters
close all
clear all
warning off;
wpms       = [];%working parameters
wpms.dirs  = struct('CWD','E:\fieldtrip\','packages','PACKAGES', ...
    'FUNCTIONS','FUNCTIONS\','RAW','RAW\','preproc','PREPROC_OUTPUT\', ...
    'DATA_DIR','EEGLAB_FORMAT\','WAVELET_OUTPUT_DIR','WAVELET_OUTPUT_DIR\', ...
    'COHERENCE_DIR','IMAGCOH_OUTPUT\','EEGDispOutput','EEGDISPLAY_OUTPUT\');

refdat = [];
refdat.fsample = 250;
refdat.sampleinfo = [];

% Setup Config
cfg = [];
cfg.layout = 'GSN128.sfp';
cfg.trials = 'all';
cfg.method = 'method';
cfg.outputfilepresent = 'overwrite';
cfg.lambda = [];
cfg.order = [];
cfg.version = [];
cfg.callinfo = [];
cfg.badchannel = {};
cfg.missingchannel = {};
cfg.neighbours = [];
cfg.previous = [];

% Building the Header Structure
hdr = [];
hdr.nChans = 128;
hdr.Fs = 250;
hdr.nSamplesPre = 0;
hdr.nTrials = 0;
hdr.nSamples = [];

% Setup the elec Struct
elec = [];
elec.label = {'FidNz','FidT9','FidT10','E1','E2','E3','E4','E5','E6','E7','E8','E9','E10','E11','E12','E13','E14','E15','E16','E17','E18','E19','E20','E21','E22','E23','E24','E25','E26',...
    'E27','E28','E29','E30','E31','E32','E33','E34','E35','E36','E37','E38','E39','E40','E41','E42','E43','E44','E45','E46','E47','E48','E49','E50','E51','E52',...
    'E53','E54','E55','E56','E57','E58','E59','E60','E61','E62','E63','E64','E65','E66','E67','E68','E69','E70','E71','E72','E73','E74','E75','E76','E77','E78',...
    'E79','E80','E81','E82','E83','E84','E85','E86','E87','E88','E89','E90','E91','E92','E93','E94','E95','E96','E97','E98','E99','E100','E101','E102','E103','E104',...
    'E105','E106','E107','E108','E109','E110','E111','E112','E113','E114','E115','E116','E117','E118','E119','E120','E121','E122','E123','E124','E125','E126','E127','E128'}';
elec.chanpos = [0,0.401484857735574,0;-0.399022097399338,-0.0137468326870708,0;0.399022094794940,-0.0137468935903123,0;0.216945249973342,0.298142446327731,0;0.167439690237735,0.270244523620880,0;0.111020833361367,0.243725473551278,0;0.0621316242533374,0.202600041447336,0;0.0365249606857617,0.154173544244571,0;0,0.0956413665582140,0;-0.0317186410232934,0.0445910604473723,0;...
    0.135474182848563,0.334630634806343,0;0.0940791199620879,0.298354351914202,0;0.0577734227661771,0.251475849900462,0;0,0.205080444005140,0;-0.0365249606857617,0.154173544244571,0;-0.0612403414348383,0.0926234795329460,0;0.0601663012528399,0.348009434799680,0;0.0319165738159106,0.304076889646476,0;0,0.260735366406048,0;0,0.382680624045053,0;-0.0319165738159107,0.304076889646476,0;-0.0577734227661771,0.251475849900462,0;-0.0621316242533374,0.202600041447336,0;...
    -0.0884532409225377,0.146919013370343,0;-0.0601663012528400,0.348009434799680,0;-0.0940791199620878,0.298354351914202,0;-0.111020833361367,0.243725473551278,0;-0.120033051088259,0.191993240769135,0;-0.135474182848563,0.334630634806343,0;-0.167439690237735,0.270244523620880,0;-0.176287393169974,0.207578687001510,0;-0.168050108498570,0.138470205179621,0;-0.129289038439138,0.0834530110180370,0;-0.0919047153993902,0.0273032943807936,0;-0.0515810255154469,-0.0269798184244452,0;...
    -0.216945249973342,0.298142446327731,0;-0.232285310776514,0.227177884959842,0;-0.227102466094632,0.133049281986599,0;-0.201068336311989,0.0723896530115111,0;-0.157553466107805,0.0102397210508679,0;-0.111500729801943,-0.0436948917516728,0;-0.315830732089710,0.234761077242395,0;-0.306924852126093,0.124460702502900,0;-0.269165317605806,0.0540659013228999,0;-0.232375902411335,-0.00282540365361990,0;-0.168032070464101,-0.0683367493232104,0;-0.402235632542026,0.201696285038364,0;...
    -0.382551248477586,0.0915648560253047,0;-0.332804282848030,0.0136912885782654,0;-0.274218878544107,-0.0541947594740311,0;-0.226525787141391,-0.0909194696300968,0;-0.450000000000000,0.0615063321457482,0;-0.315506432035610,-0.130151226693044,0;-0.254448779933902,-0.150909486914338,0;-0.186721622251492,-0.149874425678108,0;-0.126772513717673,-0.126671552802484,0;-0.0570949450109331,-0.0998572818078643,0;0,-0.0742811574706764,0;-0.393045306219834,-0.243171005662170,0;...
    -0.333685942043532,-0.206212226145345,0;-0.266541595688602,-0.227477696599073,0;-0.198126587979059,-0.221825887704360,0;-0.130453431453680,-0.197788338249622,0;-0.0675996740720496,-0.168564008158278,0;0,-0.136977833091337,0;-0.327358400657047,-0.324380194522652,0;-0.262118194086503,-0.292543863394601,0;-0.184805227080019,-0.301395254529971,0;-0.120657058080961,-0.274048507176028,0;-0.0672395475141204,-0.232437345167543,0;0,-0.187257265076832,0;...
    -0.218000574880116,-0.400673220371829,0;-0.152004043679157,-0.364169775103307,0;-0.0983133638195437,-0.337292802691852,0;-0.0594249387104834,-0.295758275017930,0;0,-0.260299163422082,0;-0.106983217443687,-0.442624869782164,0;-0.0860703222953073,-0.398631084447227,0;0,-0.345195250707591,0;0.0594249387104834,-0.295758275017930,0;0.0672395475141204,-0.232437345167543,0;0.0675996740720496,-0.168564008158278,0;0.0570949450109330,-0.0998572818078643,0;...
    0.0515810255154469,-0.0269798184244452,0;0,-0.450000000000000,0;0.0846838096220543,-0.392365453950352,0;0.0983133638195437,-0.337292802691852,0;0.120657058080961,-0.274048507176028,0;0.130453431453680,-0.197788338249622,0;0.126772513717673,-0.126671552802484,0;0.111500729801943,-0.0436948917516729,0;0.106983217443687,-0.442624869782164,0;0.152004043679157,-0.364169775103307,0;0.184805227080019,-0.301395254529971,0;0.198126587979059,-0.221825887704360,0;...
    0.186721622251492,-0.149874425678108,0;0.168032070464101,-0.0683367493232105,0;0.218000574880116,-0.400673220371829,0;0.262118194086503,-0.292543863394601,0;0.266541595688602,-0.227477696599073,0;0.254448779933902,-0.150909486914338,0;0.226525787141391,-0.0909194696300968,0;0.327358400657047,-0.324380194522652,0;0.340950765275563,-0.210459399800050,0;0.315506432035610,-0.130151226693044,0;0.274218878544107,-0.0541947594740311,0;0.232086006001878,-0.0156813866258192,0;...
    0.157553466107805,0.0102397210508679,0;0.0919047153993903,0.0273032943807936,0;0.0317186410232934,0.0445910604473723,0;0.393045306219834,-0.243171005662170,0;0.332804282848030,0.0136912885782654,0;0.269165317605806,0.0540659013228999,0;0.201068336311989,0.0723896530115111,0;0.129289038439138,0.0834530110180370,0;0.0612403414348383,0.0926234795329460,0;0.450000000000000,0.0615063321457481,0;0.382551248477586,0.0915648560253047,0;0.306924852126093,0.124460702502900,0;...
    0.227102466094632,0.133049281986599,0;0.168050108498570,0.138470205179621,0;0.0884532409225378,0.146919013370343,0;0.402235632542026,0.201696285038364,0;0.315830732089710,0.234761077242395,0;0.232285310776514,0.227177884959842,0;0.176287393169974,0.207578687001510,0;0.120033051088259,0.191993240769135,0;0.311486534626440,0.311530748447842,0;0.194059454940938,0.450000000000000,0;-0.194059454940938,0.450000000000000,0;-0.311486534626440,0.311530748447842,0];


%% Load Netstation Data
% load name_i
wpms.names = {'wc01_scenes_epoched'};
name_i = 1;


% Setup trial codes cell function
count = 1;
trial_list = zeros(1,100);
for type_i = 1:length(ECI_TCPIP_55513_)
    if ECI_TCPIP_55513_{1,type_i} == 'sngl' 
        trial_list(1,count) = 2;
        count = count +1;
    elseif  ECI_TCPIP_55513_{1,type_i} == 'rept'  
        trial_list(1,count) = 3;
        count = count +1;
%     else trial_list(1,type_i) = count;
    end
end
refdat.trialinfo = trial_list';

% Generate sampleinfo
sampleinfo = zeros(2,100);
count = 1;
for type_i = 1:length(ECI_TCPIP_55513_)
    if ECI_TCPIP_55513_{1,type_i} == 'sngl' | ECI_TCPIP_55513_{1,type_i} == 'rept' 
        sampleinfo(1,count) = ECI_TCPIP_55513_{2,type_i}-250; 
        sampleinfo(2,count) = ECI_TCPIP_55513_{2,type_i}+500;
        count = count + 1 ;
%     else sampleinfo = sampleinfo;
    end
end
refdat.sampleinfo = sampleinfo';

% Setup filenames - add a name_i loop here later
filename = 'wc01_scenes60filseg1bcr';
tc = 100;
files = cell(1,100);
for tc_i = 1:tc
    files{1,tc_i} = strcat(filename,int2str(tc_i));
end
refdat.files = files;

% Setup trial cell stucture
trial = cell(1,100);
for file_i = 1:length(files)
    g = zeros(128,751);
    f = eval(files{file_i});
    g(:,1:750) = f(1:128,:);
    trial{1,file_i} = g(:,:);
end
refdat.trial = trial;
% Setup time cell structure
times = -1:0.004:2;
time = cell(1,100);
for time_i = 1:length(time)
    time{1,time_i} = times(:,:);
end
refdat.time = time;

% Setup labels
refdat.label = {'E1','E2','E3','E4','E5','E6','E7','E8','E9','E10','E11','E12','E13','E14','E15','E16','E17','E18','E19','E20','E21','E22','E23','E24','E25','E26',...
    'E27','E28','E29','E30','E31','E32','E33','E34','E35','E36','E37','E38','E39','E40','E41','E42','E43','E44','E45','E46','E47','E48','E49','E50','E51','E52',...
    'E53','E54','E55','E56','E57','E58','E59','E60','E61','E62','E63','E64','E65','E66','E67','E68','E69','E70','E71','E72','E73','E74','E75','E76','E77','E78',...
    'E79','E80','E81','E82','E83','E84','E85','E86','E87','E88','E89','E90','E91','E92','E93','E94','E95','E96','E97','E98','E99','E100','E101','E102','E103','E104',...
    'E105','E106','E107','E108','E109','E110','E111','E112','E113','E114','E115','E116','E117','E118','E119','E120','E121','E122','E123','E124','E125','E126','E127','E128'}';
refdat.cfg = cfg;
refdat.hdr = hdr;
refdat.elec = elec;

clear tc tc_i file_i times trial trial_list f g elec cfg hdr files filename count time_i type_i time sampleinfo

% Save off data as REPAIRED_AND_REREFERENCED

save([wpms.dirs.CWD wpms.dirs.preproc wpms.names{name_i} '_REPAIRED_AND_REFERENCED'],'refdat','-v7.3');

